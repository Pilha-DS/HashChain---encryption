from tables import gerar_tabelas

def dechaveador(key:str = '', ciphertext:str = ''):
    if not key:
        raise ValueError("Coloque uma chave valída")
    if not ciphertext:
        raise ValueError("Coloque um ciphertext valído")

    lol_salt = int(key[0:3])
    index = 3 + lol_salt
    
    salt_l = int(key[3:index])
    posicoes = []

    for n in range(0, salt_l):
        pn = int(key[index:index + 3])
        index += 3  
        posicoes.append(int(key[index:index + pn]))
        index += pn

    lol_p = int(key[index:index + 3 ])
    pl = int(key[index + 3:index + 3 + lol_p])
    passes = []

    index += lol_p + 3
    for n in range(0, pl):
        passes.append(int(key[index:index + 3]))
        index += 3

    sl = int(key[index:index + 3])
    seed = int(key[index + 3:sl + index + 3])
    
    index += sl + 3

    padding = None if not key[index:] else int(key[index:])

    ciphertext_list = []

    s_index = 0

    for n in range(0, len(passes)):
        ciphertext_list.append(ciphertext[s_index:passes[n] + s_index])
        s_index += passes[n]
    
    pad = -1
    for p in range(0, len(posicoes)):
        del ciphertext_list[posicoes[pad]]
        del passes[posicoes[pad]]
        pad += -1

    return passes, seed, padding, ciphertext_list

def descrypter(key, ciphertext):
    desc = dechaveador(key, ciphertext)

    pass_ = desc[0]
    seed = desc[1]
    cipher = desc[3]

    plaintext = []

    # GERAÇÃO DE SEEDS DIFERENTES PARA CADA PASSE
    seeds_por_passe = []
    dict_tables_por_passe = {}
    
    # Usa a seed principal para gerar seeds únicas para cada passe
    for i, passe in enumerate(pass_):
        # Gera uma seed única para este passe baseada na seed principal + índice do passe
        seed_passe = seed + (i * 1000000) + passe
        seeds_por_passe.append(seed_passe)
        
        # Gera tabelas específicas para este passe
        dict_tables_passe = gerar_tabelas(seed_passe, [passe])[1]
        dict_tables_por_passe[passe] = dict_tables_passe[passe]

    for n, p in enumerate(pass_):
        try:
            plaintext.append(dict_tables_por_passe[p][cipher[n]])
        except:
            print("invalida")

    return ''.join(plaintext)

frase = '0101111100001111000101001010011101110011010100100111001101110010011000100011110010000001000110111111011000110100000100111101101011010111110101001001010010111111100011100110100001111110110011110100000100111101100111010111011111011101101011101110011010100001011111101110110111101100011001010011010110001001110010110111100110000010011110110011101011101111101110110101101001100000010000101010001110100111000010010010001100011000001001111011001111010000101001010001110101110010001001100000100111101100111010111011111011101101011010011000000100000100110111101010001001011001110011010000010011110110011101011101111101110110101110101011011011000011000101100111011101010001111111100000000010110000010011110110011101011101111101110110101101001100000010001111101110110001010100100101110101011100101010000110001101011010001110011000001001111011001110101110111110100000110000011111010100111010011011100110000010011110110011110010111011001001100100011110001101100110000010011110110011101011101111101111110001110111010101010100011100001011010000010011110110011101011101111101110110100001000001101110001101110000111100110011000001001111010010110100110011110101110010010001000110000010011110110011101011101111000001001101001110101110010000101101010110101011111000001101110001100011000011101010101110101001100001101000110000010011110110011101011101111101110110101101011111101110100001110001001100101100101001100001011110110111011011110110000010011110111010111110010001010010101010010011101000111010101000010100100011100110010111010000010011110001110111111000000010010111101100100001100000100111101100111010111011111011101101011010011000000001001000110001001010111001001000100011000001001111011001110101110111110111011010110100110000001000010011110000111011101010100101000110011000001001111011001110101000101001011000001001110000010001111011100010000001000100000011011000011000011000001001111011001110101110111110111011010111111110110010010101010100101000110011000001001111011010010000111000100000111010110001101101101010110111111000110010100001011000001001111011001110101110111110111011010111010011101101110111010111000001000111101000010010110101111111101001110111001001001100000100111101100111010010110011010001101010001001110000101101000001001111011111000011101111110101111100000100011110100000100111101100111010111011111011101111111111'
key = '0022100180021400110021100218001800221002180022100160016002140021700212002190022800212001800225002290022200238027043056028084043100058097084024100033074060075082053071027043087030052041053095099062040081056031084043062055077064566159201070773895475019935595337802501033852282398620747161663310'
enc = descrypter(key, frase)
print(enc)